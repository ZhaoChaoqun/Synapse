# InsightSentinel 后端架构总览

## 文档信息
- **版本**: v1.0
- **创建日期**: 2026-02-06
- **技术栈**: Python + FastAPI

---

## 1. 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                     Frontend (React 19)                          │
│  ┌─────────────┬─────────────┬─────────────┬─────────────────┐  │
│  │  LogPanel   │  StatsGrid  │ NetworkMap  │   CommandBar    │  │
│  └─────────────┴─────────────┴─────────────┴─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ REST API / SSE / WebSocket
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Backend (FastAPI)                            │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      API Layer                             │  │
│  │  /agent/execute  /intelligence/search  /platforms/stats   │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Service Layer                           │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │  │
│  │  │ Agent       │  │ Analysis    │  │ Notification    │   │  │
│  │  │ Orchestrator│  │ Service     │  │ Service         │   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Core Layer                              │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌───────────────┐   │  │
│  │  │ Planner │ │Executor │ │ Critic  │ │   Resilience  │   │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └───────────────┘   │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │              Tool Registry                          │  │  │
│  │  │  [Search] [Scrape] [Analyze] [Memory] [Timeline]   │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   LLM Layer     │ │  Crawler Layer  │ │  Memory Layer   │
│  ┌───────────┐  │ │  ┌───────────┐  │ │  ┌───────────┐  │
│  │Gemini Flash│ │ │  │  微信     │  │ │  │PostgreSQL │  │
│  │(轻量任务)  │  │ │  │  知乎     │  │ │  │(结构化)   │  │
│  └───────────┘  │ │  │  小红书   │  │ │  └───────────┘  │
│  ┌───────────┐  │ │  │  抖音     │  │ │  ┌───────────┐  │
│  │Gemini Pro │  │ │  └───────────┘  │ │  │ pgvector  │  │
│  │(复杂分析)  │  │ │  ┌───────────┐  │ │  │(向量搜索) │  │
│  └───────────┘  │ │  │ AntiDetect│  │ │  └───────────┘  │
│                 │ │  │ ProxyPool │  │ │  ┌───────────┐  │
│                 │ │  └───────────┘  │ │  │  Redis    │  │
│                 │ │                 │ │  │(缓存/队列)│  │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

---

## 2. 目录结构

```
insightsentinel-backend/
├── app/
│   ├── __init__.py
│   ├── main.py                      # FastAPI 入口
│   ├── config.py                    # 配置管理
│   │
│   ├── api/                         # API 层
│   │   ├── __init__.py
│   │   ├── deps.py                  # 依赖注入
│   │   └── v1/
│   │       ├── router.py            # 路由聚合
│   │       ├── endpoints/
│   │       │   ├── agent.py         # Agent 控制
│   │       │   ├── intelligence.py  # 情报查询
│   │       │   ├── platforms.py     # 平台数据
│   │       │   └── websocket.py     # WebSocket
│   │       └── schemas/             # Pydantic 模型
│   │
│   ├── core/                        # 核心业务逻辑
│   │   ├── agent/                   # Agentic Loop
│   │   │   ├── orchestrator.py      # 编排器
│   │   │   ├── planner.py           # 规划器
│   │   │   ├── executor.py          # 执行器
│   │   │   ├── critic.py            # 批判器
│   │   │   └── state.py             # 状态管理
│   │   │
│   │   ├── tools/                   # Agent 工具集
│   │   ├── llm/                     # LLM 抽象层
│   │   └── resilience/              # 错误自愈
│   │
│   ├── crawlers/                    # 爬虫模块
│   │   ├── base.py                  # 爬虫基类
│   │   ├── wechat/                  # 微信公众号
│   │   ├── zhihu/                   # 知乎
│   │   ├── xiaohongshu/             # 小红书
│   │   ├── douyin/                  # 抖音
│   │   └── anti_detect/             # 反检测
│   │
│   ├── memory/                      # 记忆系统
│   │   ├── vector_store.py          # 向量存储
│   │   ├── relational_store.py      # 关系存储
│   │   └── retriever.py             # 检索器
│   │
│   ├── models/                      # 数据模型
│   ├── services/                    # 业务服务
│   └── utils/                       # 工具函数
│
├── migrations/                      # Alembic 迁移
├── tests/                           # 测试
├── docker/                          # Docker 配置
├── pyproject.toml
└── README.md
```

---

## 3. 核心模块职责

| 模块 | 职责 | 关键文件 |
|------|------|---------|
| **API Layer** | HTTP 端点、请求验证、响应格式化 | `api/v1/endpoints/` |
| **Agent Core** | Agentic Loop 编排、任务规划与执行 | `core/agent/` |
| **Tools** | Agent 可调用的工具（搜索、抓取、分析） | `core/tools/` |
| **LLM** | Gemini API 封装、模型路由、Token 追踪 | `core/llm/` |
| **Crawlers** | 平台数据抓取、反检测、代理管理 | `crawlers/` |
| **Memory** | 向量存储、语义搜索、时间线索引 | `memory/` |
| **Resilience** | 重试策略、熔断器、降级处理 | `core/resilience/` |

---

## 4. 技术选型

| 组件 | 选型 | 理由 |
|------|------|------|
| Web 框架 | FastAPI | 异步支持、自动文档、类型安全 |
| 数据库 | PostgreSQL | 成熟稳定、支持 pgvector |
| 向量搜索 | pgvector | 与 PostgreSQL 集成、部署简单 |
| 缓存/队列 | Redis | 高性能、支持多种数据结构 |
| LLM | Gemini API | 成本效益、多模态支持 |
| 爬虫 | aiohttp + Playwright | 异步 HTTP + 动态渲染 |

---

## 5. 相关文档

- [后端详细设计](./backend.md)
- [数据库 Schema](./database.md)
- [Agent 核心设计](./agent.md)
- [爬虫系统设计](./crawler.md)
